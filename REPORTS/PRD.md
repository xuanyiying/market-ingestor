# 产品需求文档 (PRD) - Market Ingestor 增强版

## 1. 需求背景与业务目标
`market-ingestor` 目前已实现了稳定的多交易所数据接入与 1 分钟线聚合。为了进一步支撑量化交易业务，需要将系统从单纯的“数据采集器”演进为“行情处理与策略触发中心”。

**业务目标：**
- 支持多周期技术指标分析。
- 实现实时策略监控与信号触发。
- 提供完整的历史数据回溯能力。

## 2. 功能规格说明书

### 2.1 多周期 K 线聚合器 (Multi-Interval Aggregator)
- **优先级**：P0
- **功能点**：
    - 支持配置多个聚合周期：1m, 5m, 15m, 1h, 1d。
    - 维持各周期的独立内存状态，确保数据互不干扰。
    - 通过 NATS 发布不同周期的消息：`market.kline.{interval}.{symbol}`。

### 2.2 实盘策略执行引擎 (Live Strategy Engine)
- **优先级**：P0
- **功能点**：
    - 动态加载策略插件（基于已有 `Strategy` 接口）。
    - 订阅 `market.kline.1m.*` 主题，实时驱动策略计算。
    - 记录并输出策略生成的 Action (Buy/Sell/Hold) 到日志及数据库。

### 2.3 历史数据回填服务 (Backfill Service)
- **优先级**：P1
- **功能点**：
    - 提供 REST API 触发指定交易所、交易对及时间段的数据回填。
    - 自动处理交易所 Rate Limit，实现断点续传。
    - 将回填数据标记为 `is_backfilled` 存入数据库。

### 2.4 回测与信号监控 UI
- **优先级**：P2
- **功能点**：
    - 展示策略实时生成的信号 (Live Signals)。
    - 提供回测参数设置界面并展示可视化回测报告。
    - **实现状态**：已使用 React + Tailwind + ECharts 完成重写，支持实时信号推送订阅。

## 3. 技术可行性分析

- **计算性能**：Go 的高并发能力足以处理数十个交易对的多周期聚合（内存开销约每个窗口 <1KB）。
- **消息传递**：NATS JetStream 支持通配符订阅，方便策略引擎按需订阅特定周期的数据。
- **存储压力**：TimescaleDB 的 Hypertable 设计天然适合处理多周期时序数据。

## 4. 预期 KPI 指标

- **延迟**：从收到原始 Trade 到发布 1m K 线延迟 < 50ms。
- **稳定性**：系统连续运行 7x24 小时无 OOM 或死锁。
- **测试覆盖**：核心业务逻辑（聚合、策略触发）单元测试覆盖率 > 80%。
- **吞吐量**：单实例支持至少 5000 Trade/s 的处理能力。
